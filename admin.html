<!-- File: admin.html (GAS HtmlService) -->
<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Works Admin</title>
    <style>
        :root {
            --bg: #faf7f2;
            --paper: #fff;
            --ink: #2f2a28;
            --frame: #e6dccf;
            --accent: #b86b5e;
        }

        body {
            font: 14px/1.45 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            margin: 18px;
            color: var(--ink);
            background: var(--bg)
        }

        h1 {
            margin: 0 0 10px
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin: 12px 0 16px
        }

        .toolbar>* {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 10px
        }

        .toolbar select,
        .toolbar input {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 8px
        }

        .btn {
            cursor: pointer
        }

        .btn.primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent)
        }

        .status {
            margin-left: 8px
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap
        }

        .tabs button {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer
        }

        .tabs button[aria-pressed="true"] {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent)
        }

        .row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap
        }

        .col {
            flex: 1 1 360px;
            background: #fff;
            border: 1px solid var(--frame);
            border-radius: 12px;
            padding: 12px
        }

        ul {
            list-style: none;
            margin: 0;
            padding: 0;
            border: 1px dashed #d8cec0;
            border-radius: 8px;
            min-height: 240px;
            background: #fff
        }

        li {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            cursor: grab
        }

        li:last-child {
            border-bottom: 0
        }

        li.dragging {
            opacity: .5
        }

        .thumb {
            width: 60px;
            height: 45px;
            object-fit: cover;
            border-radius: 6px;
            background: #f2f2f2
        }

        .muted {
            color: #777
        }

        .small {
            font-size: 12px
        }

        .danger {
            color: #a00
        }
    </style>
</head>

<body>
    <h1>Works Admin</h1>

    <div class="toolbar">
        <div>
            <label class="small">Upload to category:
                <select id="catSel"></select>
            </label>
            <input id="files" type="file" multiple accept="image/*">
            <button id="uploadBtn" class="btn">Upload</button>
        </div>
        <button id="saveBtn" class="btn primary">Save Order</button>
        <span id="status" class="status muted"></span>
    </div>

    <div id="tabs" class="tabs"></div>

    <div id="lists" class="row"></div>

    <p class="small muted">
        “All” tab shows a combined preview (read-only). Reorder within each category; your public site reads
        <code>assets/works/works.json</code>.
    </p>

    <script>
        let manifest = {};
        let current = null;

        // GAS web app /exec URL for uploads (same origin: no CORS)
        const EXEC_URL = '<?= ScriptApp.getService().getUrl(); ?>';

        function el(tag, props = {}, ...kids) {
            const n = document.createElement(tag);
            Object.assign(n, props);
            for (const k of kids) n.append(k);
            return n;
        }

        function setStatus(t, isErr = false) {
            const el = document.getElementById('status');
            el.textContent = t;
            el.className = 'status ' + (isErr ? 'danger' : 'muted');
        }

        function loadManifest() {
            return new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(m => {
                    manifest = m || {};
                    resolve();
                }).withFailureHandler(err => {
                    console.error(err);
                    reject(err);
                }).getManifestObj();
            });
        }

        function saveOrder() {
            return new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(res => {
                    if (res && res.ok) { resolve(); }
                    else { reject(new Error('save failed')); }
                }).withFailureHandler(err => reject(err))
                    .saveManifest(manifest);
            });
        }

        function renderTabs() {
            const tabs = document.getElementById('tabs');
            tabs.innerHTML = '';

            // Build tab list: ["all", ...actual categories]
            const cats = Object.keys(manifest);
            const tabList = ['all', ...cats];

            if (!current) current = tabList[0];

            tabList.forEach(cat => {
                const label = cat === 'all' ? 'All (read-only)' : cat;
                const b = el('button', { textContent: label, onclick() { current = cat; renderLists(); } });
                b.setAttribute('aria-pressed', cat === current);
                tabs.append(b);
            });

            // fill upload category selector
            const sel = document.getElementById('catSel');
            sel.innerHTML = cats.map(c => `<option>${c}</option>`).join('');
            if (cats.length) sel.value = cats[0];
        }

        function renderLists() {
            const lists = document.getElementById('lists');
            lists.innerHTML = '';

            if (current === 'all') {
                // read-only combined preview
                const ul = el('ul');
                const combined = [];
                Object.entries(manifest).forEach(([cat, arr]) => {
                    arr.forEach(name => combined.push({ cat, name }));
                });
                combined.forEach(({ cat, name }) => {
                    const li = el('li', { draggable: false });
                    const img = el('img', { className: 'thumb', src: `assets/works/${cat}/${encodeURIComponent(name)}` });
                    li.append(img, el('span', { textContent: `[${cat}] ${name}` }));
                    ul.append(li);
                });
                lists.append(el('div', { className: 'col' }, el('h3', { textContent: 'All (preview)' }), ul));
                return;
            }

            if (!manifest[current]) {
                lists.append(el('div', { className: 'col' }, el('p', { className: 'muted', textContent: 'No items in this category.' })));
                return;
            }

            const ul = el('ul', { id: 'ul-' + current });
            (manifest[current] || []).forEach(name => {
                const li = el('li', { draggable: true });
                li.addEventListener('dragstart', () => li.classList.add('dragging'));
                li.addEventListener('dragend', () => li.classList.remove('dragging'));
                const img = el('img', { className: 'thumb', src: `assets/works/${current}/${encodeURIComponent(name)}` });
                li.append(img, el('span', { textContent: name }));
                ul.append(li);
            });
            enableDnd(ul, names => { manifest[current] = names; setStatus('Order changed (not saved yet)'); });

            // Right: manifest preview (all categories)
            const preview = el('div', { className: 'small' });
            Object.entries(manifest).forEach(([cat, arr]) => {
                preview.append(
                    el('div', {},
                        el('strong', { textContent: cat + ` (${arr.length})` }),
                        el('div', { className: 'muted' }, document.createTextNode(arr.join(', ')))
                    )