<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Works Admin</title>
    <style>
        :root {
            --bg: #faf7f2;
            --paper: #fff;
            --ink: #2f2a28;
            --frame: #e6dccf;
            --accent: #b86b5e;
        }

        body {
            font: 14px/1.45 system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            margin: 18px;
            color: var(--ink);
            background: var(--bg)
        }

        h1 {
            margin: 0 0 10px
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            margin: 12px 0 16px
        }

        .toolbar>* {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 10px
        }

        .toolbar select,
        .toolbar input {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 8px
        }

        .btn {
            cursor: pointer
        }

        .btn.primary {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent)
        }

        .status {
            margin-left: 8px
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin: 10px 0
        }

        .tabs button {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background: #fff;
            cursor: pointer
        }

        .tabs button[aria-pressed="true"] {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent)
        }

        .row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap
        }

        .col {
            flex: 1 1 360px;
            background: #fff;
            border: 1px solid var(--frame);
            border-radius: 12px;
            padding: 12px
        }

        ul {
            list-style: none;
            margin: 0;
            padding: 0;
            border: 1px dashed #d8cec0;
            border-radius: 8px;
            min-height: 240px;
            background: #fff
        }

        li {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
            cursor: grab
        }

        li:last-child {
            border-bottom: 0
        }

        li.dragging {
            opacity: .5
        }

        .thumb {
            width: 60px;
            height: 45px;
            object-fit: cover;
            border-radius: 6px;
            background: #f2f2f2
        }

        .muted {
            color: #777
        }

        .help {
            margin-top: 8px;
            color: #555
        }

        .small {
            font-size: 12px
        }

        .danger {
            color: #a00
        }
    </style>
</head>

<body>
    <h1>Works Admin</h1>

    <div class="toolbar">
        <div>
            <label class="small">Upload to category:
                <select id="catSel"></select>
            </label>
            <input id="files" type="file" multiple accept="image/*" />
            <button id="uploadBtn" class="btn">Upload</button>
        </div>
        <button id="saveBtn" class="btn primary">Save Order</button>
        <span id="status" class="status muted"></span>
    </div>

    <div id="tabs" class="tabs"></div>

    <div id="lists" class="row"></div>

    <p class="help small">
        Tip: drag items to reorder. Upload adds files to the selected category and updates
        <code>assets/works/works.json</code>.
    </p>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbzAZ6Qhn8AvMR_c-NINqQG-3z_0NS6ecQ6qMATCFLbeUCljyO3exGL_3WbNpacgllvo/exec'; // <-- set your /exec URL

        let manifest = {};
        let current = null;

        function el(tag, props = {}, ...kids) {
            const n = document.createElement(tag);
            Object.assign(n, props);
            for (const k of kids) n.append(k);
            return n;
        }

        async function loadManifest() {
            const r = await fetch(API + '?endpoint=manifest', { method: 'GET', credentials: 'omit' });
            if (!r.ok) throw new Error('manifest fetch failed');
            manifest = await r.json();
            // manifest is JSON string if returned raw; ensure object
            if (typeof manifest === 'string') { try { manifest = JSON.parse(manifest); } catch (_) { } }
        }

        function renderTabs() {
            const tabs = document.getElementById('tabs');
            tabs.innerHTML = '';
            const cats = Object.keys(manifest);
            if (!cats.length) {
                tabs.append(el('span', { textContent: 'No categories found in manifest', className: 'muted' }));
                return;
            }
            if (!current) current = cats[0];
            cats.forEach(cat => {
                const b = el('button', { textContent: cat, onclick() { current = cat; renderLists(); } });
                b.setAttribute('aria-pressed', cat === current);
                tabs.append(b);
            });
        }

        function renderLists() {
            const lists = document.getElementById('lists');
            lists.innerHTML = '';

            if (!current || !manifest[current]) {
                lists.append(el('div', { className: 'col' }, el('p', { className: 'muted', textContent: 'No category selected.' })));
                return;
            }

            // Left: current category reorder list
            const ul = el('ul', { id: 'ul-' + current });
            (manifest[current] || []).forEach(name => {
                const li = el('li', { draggable: true });
                li.addEventListener('dragstart', () => li.classList.add('dragging'));
                li.addEventListener('dragend', () => li.classList.remove('dragging'));
                const img = el('img', { className: 'thumb', src: `assets/works/${current}/${encodeURIComponent(name)}` });
                li.append(img, el('span', { textContent: name }));
                ul.append(li);
            });
            enableDnd(ul, names => { manifest[current] = names; });

            // Right: manifest preview (all categories)
            const all = el('div', { className: 'small' });
            Object.entries(manifest).forEach(([cat, arr]) => {
                all.append(
                    el('div', {},
                        el('strong', { textContent: cat + ` (${arr.length})` }),
                        el('div', { className: 'muted' }, document.createTextNode(arr.join(', ')))
                    )
                );
            });

            lists.append(
                el('div', { className: 'col' }, el('h3', { textContent: 'Reorder: ' + current }), ul),
                el('div', { className: 'col' }, el('h3', { textContent: 'Manifest preview' }), all)
            );

            // Category picker for upload
            const sel = document.getElementById('catSel');
            sel.innerHTML = Object.keys(manifest).map(c => `<option>${c}</option>`).join('');
            sel.value = current;
        }

        function enableDnd(ul, onChange) {
            ul.addEventListener('dragover', e => {
                e.preventDefault();
                const after = getDragAfterElement(ul, e.clientY);
                const dragging = ul.querySelector('.dragging');
                if (!dragging) return;
                if (after == null) ul.appendChild(dragging);
                else ul.insertBefore(dragging, after);
            });

            ul.addEventListener('drop', () => {
                const names = Array.from(ul.querySelectorAll('li span')).map(s => s.textContent);
                onChange(names);
                setStatus('Order changed (not saved yet)');
            });
        }

        function getDragAfterElement(container, y) {
            const els = [...container.querySelectorAll('li:not(.dragging)')];
            return els.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        async function saveOrder() {
            try {
                const r = await fetch(API + '?endpoint=update-order', {
                    method: 'POST',
                    // Important: no custom headers → browser sends text/plain → no preflight
                    body: JSON.stringify({ manifest }),
                    credentials: 'omit'
                });
                if (!r.ok) throw new Error('save failed');
                setStatus('Saved ✅');
            } catch (e) {
                console.error(e);
                setStatus('Save failed', true);
            }
        }

        async function upload() {
            const cat = document.getElementById('catSel').value;
            const inp = document.getElementById('files');
            if (!inp.files.length) return setStatus('Select files first', true);

            const fd = new FormData();
            fd.append('category', cat);
            for (const f of inp.files) fd.append('files', f, f.name);

            try {
                const r = await fetch(API + '?endpoint=upload', {
                    method: 'POST',
                    body: fd,
                    credentials: 'omit'
                });
                if (!r.ok) throw new Error('upload failed');

                setStatus('Uploaded ✅');
                await loadManifest();
                renderTabs();
                renderLists();
                inp.value = '';
            } catch (e) {
                console.error(e);
                setStatus('Upload failed', true);
            }
        }

        function setStatus(t, isErr = false) {
            const el = document.getElementById('status');
            el.textContent = t;
            el.className = 'status ' + (isErr ? 'danger' : 'muted');
        }

        // Init
        (async function () {
            try {
                await loadManifest();
                renderTabs();
                renderLists();
                setStatus('Ready');
            } catch (e) {
                console.error(e);
                setStatus('Failed to load manifest', true);
            }
        })();

        document.getElementById('saveBtn').addEventListener('click', saveOrder);
        document.getElementById('uploadBtn').addEventListener('click', upload);
    </script>
</body>

</html>